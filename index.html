<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Compras</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f7f7f7; color: #333;
      display: flex; flex-direction: column;
      min-height: 100vh;
    }
    header {
      background: #4CAF50; color: white;
      text-align: center; padding: 1rem;
      font-size: 1.4rem;
    }
    main { flex: 1; padding: 1rem; }
    table {
      width: 100%;
      border-spacing: 0 0.5rem;
    }
    th, td { text-align: left; padding: 0.5rem; }
    th.num, td.num { text-align: right; }
    tr {
      background: white; border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    input[type="text"], input[type="number"] {
      width: 100%; border: 1px solid #ccc;
      border-radius: 4px; padding: 0.4rem;
      font-size: 1rem;
    }
    input:focus { outline: 2px solid #4CAF50; }
    button {
      border: none; border-radius: 6px;
      padding: 0.6rem 1rem; cursor: pointer;
      font-size: 1rem;
      background: #4CAF50; color: white;
      transition: background 0.2s;
    }
    button:hover { background: #43A047; }
    button.delete-btn {
      background: none; color: #e53935;
      padding: 0.4rem;
    }
    button.delete-btn:hover { color: #b71c1c; }
    .toolbar {
      display: flex; flex-wrap: wrap;
      gap: 0.5rem; justify-content: center;
      padding: 1rem; background: white;
      border-top: 1px solid #ddd;
    }
    @media (max-width: 600px) {
      th:nth-child(1), td:nth-child(1) { width: 45%; }
      th:nth-child(2), th:nth-child(3), th:nth-child(4) { width: 15%; }
      th:nth-child(5) { width: 10%; }
    }
    .total-geral {
      text-align: right; margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>ğŸ›’ Lista de Compras</header>
  <main>
    <table id="tabela">
      <thead>
        <tr>
          <th>Produto</th>
          <th class="num">Qtd</th>
          <th class="num">Valor</th>
          <th class="num">Total</th>
          <th>AÃ§Ã£o</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="total-geral" id="totalGeral"></div>
  </main>
  <div class="toolbar">
    <button id="addBtn" title="Adicionar linha" aria-label="Adicionar">â• Adicionar</button>
    <button id="saveBtn" title="Salvar JSON" aria-label="Salvar">ğŸ’¾ Salvar</button>
    <button id="loadBtn" title="Carregar JSON" aria-label="Carregar">ğŸ“‚ Carregar</button>
    <button id="clearBtn" title="Limpar lista" aria-label="Limpar">ğŸ§¹ Limpar</button>
    <button id="pdfBtn" title="Gerar PDF" aria-label="Gerar PDF">ğŸ“„ PDF</button>
  </div>

  <!-- Bibliotecas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const tbody = document.querySelector('#tabela tbody');
    const totalGeralEl = document.getElementById('totalGeral');

    function salvarLocalStorage() {
      const linhas = [...tbody.querySelectorAll('tr')].map(tr => {
        const [produto, qtd, valor] = tr.querySelectorAll('input');
        return {
          produto: produto.value.trim(),
          qtd: qtd.value ? parseFloat(qtd.value) : '',
          valor: valor.value ? parseFloat(valor.value) : ''
        };
      });
      localStorage.setItem('listaCompras', JSON.stringify(linhas));
    }

    function carregarLocalStorage() {
      const dados = JSON.parse(localStorage.getItem('listaCompras') || '[]');
      if (dados.length === 0) addLinha();
      else dados.forEach(d => addLinha(d));
    }

    function addLinha(item = { produto:'', qtd:'', valor:'' }) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" value="${item.produto}" aria-label="Produto"></td>
        <td><input type="number" value="${item.qtd}" aria-label="Quantidade"></td>
        <td><input type="number" step="0.01" value="${item.valor}" aria-label="Valor"></td>
        <td class="num total"></td>
        <td><button class="delete-btn" title="Excluir" aria-label="Excluir linha">
          ğŸ—‘ï¸
        </button></td>
      `;
      tbody.appendChild(tr);

      const [produto, qtd, valor] = tr.querySelectorAll('input');
      const totalCell = tr.querySelector('.total');

      function atualizarTotal() {
        const q = parseFloat(qtd.value);
        const v = parseFloat(valor.value);
        if (!isNaN(q) && !isNaN(v)) totalCell.textContent = (q * v).toFixed(2);
        else totalCell.textContent = '';
        atualizarTotalGeral();
        salvarLocalStorage();
      }

      produto.addEventListener('input', salvarLocalStorage);
      qtd.addEventListener('input', atualizarTotal);
      valor.addEventListener('input', atualizarTotal);

      tr.querySelector('.delete-btn').addEventListener('click', () => {
        const temDados = produto.value || qtd.value || valor.value;
        if (!temDados || confirm('Excluir esta linha?')) {
          tr.remove();
          atualizarTotalGeral();
          salvarLocalStorage();
        }
      });

      atualizarTotal();
      produto.focus();
    }

    function atualizarTotalGeral() {
      let total = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        const val = parseFloat(tr.querySelector('.total').textContent);
        if (!isNaN(val)) total += val;
      });
      totalGeralEl.textContent = total ? `Total geral: R$ ${total.toFixed(2)}` : '';
    }

    document.getElementById('addBtn').onclick = () => addLinha();

    document.getElementById('saveBtn').onclick = () => {
      const nome = prompt('Nome do arquivo:', 'lista_compras').replace(/[\\/]/g, '_');
      if (!nome) return;
      const blob = new Blob([localStorage.getItem('listaCompras')], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = nome + '.json';
      a.click();
    };

    document.getElementById('loadBtn').onclick = () => {
      const input = document.createElement('input');
      input.type = 'file'; input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const dados = JSON.parse(reader.result);
            if (!Array.isArray(dados)) throw 'Formato invÃ¡lido';
            tbody.innerHTML = '';
            dados.forEach(d => addLinha(d));
            salvarLocalStorage();
          } catch {
            alert('Arquivo JSON invÃ¡lido.');
          }
        };
        reader.readAsText(file);
      };
      input.click();
    };

    document.getElementById('clearBtn').onclick = () => {
      if (confirm('Tem certeza que deseja limpar tudo?')) {
        tbody.innerHTML = '';
        addLinha();
        salvarLocalStorage();
      }
    };

    document.getElementById('pdfBtn').onclick = async () => {
      const nome = prompt('Nome do PDF:', 'lista_compras').replace(/[\\/]/g, '_');
      if (!nome) return;
      const dados = [...tbody.querySelectorAll('tr')].map(tr => {
        const [p, q, v] = tr.querySelectorAll('input');
        return [p.value, q.value, v.value, tr.querySelector('.total').textContent];
      });

      const hasUnicode = JSON.stringify(dados).match(/[^\u0000-\u007f]/);
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      try {
        if (!hasUnicode) {
          doc.text('Lista de Compras', 14, 15);
          doc.autoTable({
            head: [['Produto','Qtd','Valor','Total']],
            body: dados,
            startY: 20
          });
          doc.text(totalGeralEl.textContent, 14, doc.lastAutoTable.finalY + 10);
          doc.save(nome + '.pdf');
        } else {
          throw 'Unicode';
        }
      } catch {
        const canvas = await html2canvas(document.querySelector('main'));
        const img = canvas.toDataURL('image/png');
        const pdf = new jsPDF({ orientation: 'portrait' });
        pdf.addImage(img, 'PNG', 10, 10, 190, 0);
        pdf.save(nome + '.pdf');
      }
    };

    carregarLocalStorage();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
